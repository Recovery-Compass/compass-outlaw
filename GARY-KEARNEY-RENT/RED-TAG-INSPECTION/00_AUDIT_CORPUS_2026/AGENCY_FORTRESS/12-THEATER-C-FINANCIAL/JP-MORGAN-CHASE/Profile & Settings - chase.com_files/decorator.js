define(["require","appkit-utilities/rapidash/rapidash","blue/$","blue-app/component/validator","profileArea/sharedLib/sharedView/decorators/exitDialog/ractiveModelCache","appkit-utilities/content/dcu","blue/event/channel/component","common/lib/fakeComponent","blue-view-ractive/ractive"],(function(e){var t=e("appkit-utilities/rapidash/rapidash"),r=e("blue/$"),i=e("blue-app/component/validator"),n=e("profileArea/sharedLib/sharedView/decorators/exitDialog/ractiveModelCache"),a=e("appkit-utilities/content/dcu").dynamicContent,o=e("blue/event/channel/component"),l=e("common/lib/fakeComponent");return function(s,d){return function(){return function(u,c){(d=d||{}).customValidations=d.customValidations||[],d.ignoreFrameworkValidation=d.ignoreFrameworkValidation||!1,d.cancelButton=d.cancelButton||"";var f,p,v,m,g,b,h,y,V,k,E,A,w,C=this,M=e("blue-view-ractive/ractive");C.decoratorNode=u;var S,F,D,I,N,x,_,B=C.get("savedOriginalState"),L=B||r(u).serialize(),R={},H=!1,O={},T=!0,P=function(e){return e.bridge.name=e.bridge.name.replace("-bridge",""),l(e.bridge.name.toUpperCase(),"profileArea")},j=(I=d.customValidations,N={},x=[],_=[],I&&I.forEach((function(e){switch(e.type){case"field":var t=e.field;N[t]=N[t]||[],N[t].push(e);break;case"fields":(e.fields&&Array.isArray(e.fields)?e.fields:[]).forEach((function(t){N[t]=N[t]||[],N[t].push(e)}));break;case"form":x.push(e);break;case"submit":_.push(e)}})),{fieldValidations:N,formValidations:x,submitValidations:_});S=j.fieldValidations,F=j.formValidations,D=j.submitValidations,n.set(C,s);var q=function(e){var t=r(e).find('button[type="submit"]'),i=this.findAllComponents("blueButton").filter((function(e){return"submit"===e.get("type")})),n=void 0,a=r(".skiplink-container"),o=!0,l=function(e){var i=r(e.target).is(t)||r(e.target).parent().is(t);if((r(e.target).is("input")||i)&&(13===e.keyCode||"click"===e.type)){if(o)return!!r(e.target).hasClass("accordion-link")||(e.preventDefault(),!1);var n=p();if(!n.isValid)return s.context.broadcast("clearEmailHeaderConfirmation"),f.show(n.errorTitle,n.errorMessage),e.preventDefault(),!1;f.hide()}};d.cancelButton&&s.bridge.output.on("ractiveModelCacheExitDialog",(function(e){(n=s.rtemplate.findAllComponents("blueButton").find((function(e){return"doNotUpdateMyIncome"===e.get("id")})))&&n.set("disabled",!e.data.isDirty)}));var u=function(){r(e).on("keydown keypress keyup",l),t.on("click",l)};return u(),{enable:function(){o=!1,t.prop("disabled",o),i?i.forEach((function(e){e.set("disabled",o)})):s.bridge.output.emit("toggleSubmitButton",{disabled:o}),a.hide()},disable:function(){o=!0,t.prop("disabled",o),i?i.forEach((function(e){e.set("disabled",o)})):s.bridge.output.emit("toggleSubmitButton",{disabled:o}),a.show()},reset:function(){t.off("click",l),t=r(e).find('button[type="submit"]'),r(e).off("keydown keypress keyup",l),u()}}}.call(this,u);f=function(e){var t=M.getNodeInfo(e).keypath?M.getNodeInfo(e).keypath+".formValidatorError":"formValidatorError";return{show:function(e,r,i){i?i+=".formValidatorError":i=t,C.set(i+".title",e),C.set(i+".message",r),C.set(i+".additionalContent",null),C.set(i+".display",!0)},hide:function(e){e?e+=".formValidatorError":e=t,C.get(e)&&C.set(e+".display",!1)}}}(u);var $,z,U=function(){var e,i=[];s.bridge.on("trigger/serverValidation",(function(e){var r=y(e),i=r.errorHeader||"",n=r.errorAdvisory||"";if(f.show(i,n,e.dataPath),r.field){var a=t.get(R,r.field+".node");v(a,r.errorField,true),s.bridge.output.emit("state",{value:"saveMailingAddressChangesEnded",node:a}),V.resetFocusState()}r.enableJitButton&&q.enable()}));var a=function(e,r){e&&e.data?f.hide(e.data):f.hide(),e&&(O={},g().forEach((function(e){var i=t.get(R,e.name+".node");if(i){if(r&&r[i.name])return;m(i),m(i,!0)}}))),e.skipJIT||q.disable()};s.bridge.on("trigger/clearValidation",a);var l=function(e){if(e&&e.context&&e.context.id){var t=e.context.id;if(document.querySelector){var r=document.querySelector("#"+t);if(r){var i=M.getNodeInfo(r).ractive,n=i.find("input");n&&(e.context.newValue&&i.set("value",e.context.newValue),h(n,!0,!0,!0))}}}};s.bridge.output.on("runValidation",l),s.bridge.on("trigger/runValidation",l);var d=function(e){var t=e.data.name,r=e.data.clearAll||!1,i=e.data.clearException||!1,n=document.querySelector('[name="'+t+'"]');n&&n.value&&""!==n.value.trim()?(a(r,i),h(n,!0,!0,!0)):a(r,i)};s.bridge.output.on("revalidate",d),e=o.on("revalidate",d)[0],i.push(e);var c=function(e){var t={};return e.split("&").forEach((function(e){var r=e.split("=");2===r.length&&(t[r[0]]=r[1])})),t},p=function(){var e=r(u).serialize(),t=c(L),i=c(e);t.service!==i.service||B||(L=r(u).serialize()),n.teardown(),n.set(C,s),A()};return s.bridge.output.on("resetDirtyState",p),s.bridge.on("trigger/resetDirtyState",p),{parseString:c,teardown:function(){i.forEach((function(e){e()}))}}}(),G=(z=function(e,t){var r=$(e);r&&v(r,t,!0)},{get:$=function(e){var r=t.get(R,e);if(r)return r.node},set:z,clear:function(e){z(e,null)}}),J=function(e,t,r,n){var a=e.type||e,o=e.params||e,l=i.validate(t.value.trim(),a,o,e),s=n+"Error",d=t.value.trim();return t.required&&""===d?(r.setting=s,r.variation="MISSING_MANDATORY_DATA",l.isValid=!1):l.isValid||(""===d?l.isValid=!0:l.failedConstraints&&l.failedConstraints[0]&&"NotPhoneEmail"===l.failedConstraints[0].type?(r.setting=s,r.variation="EMAIL_ADDRESS_CANNOT_BE_PHONE_NUMBER"):(r.setting=s,r.variation="INVALID_FORMAT")),l.errorMessage=r,l},Y=function(e){if(e)return"string"==typeof e?e:a.get(e.spec,e.setting+"."+e.variation)};p=function(){if(T){if(D)for(var e=0;e<D.length;e++){var t=D[e];if(!t.validator.call(G,C,L,c,s))return{isValid:!1,errorTitle:Y(t.title),errorMessage:Y(t.message)}}return{isValid:!0}}},A=function(){var e=g();if(q.reset(),w())return q.disable();for(var t=0;t<e.length;t++){if(!h(e[t],!1,!1,!1).isValid)return q.disable()}return function(){if(T){if(F)for(var e=0;e<F.length;e++)if(!F[e].validator.call(G,C,L,c,s))return!1;return!0}}()?q.enable():q.disable()},h=function(e,r,i,n){var a;b();var o=t.get(R,e.name+".component");return d.ignoreFrameworkValidation||(a=function(e){if(T){var r,i,n,a=k(e.name),o=a.property,l=s.compSpec,d=s.compSpecValidationName;return d&&(n=l.data[d].items?l.data[d].items:l.data[d]),(i=n||t.get(s,"component.spec.data."+a.specpath))&&a.isListType?r=i[o]:i&&!a.isListType&&(r=i),r?J(r,e,{},o):{isValid:!0}}}(e)||{},o&&o.set("validationResult",a.isValid),a.isValid)?(delete O[e.name],E(e,r,i,n)):(n&&(O[e.name]=!0),r&&v(e,a.errorMessage,i),a)},E=function(e,r,i,n){var a;b();var o=t.get(R,e.name+".component");return a=function(e){if(!T)return{isValid:!0};var t=k(e.name).keypath,r=S[t];if(r)for(var i=0;i<r.length;i++){var n=r[i],a=t!==n.field?n.field:null;if(!n.validator.call(G,C,L,c,s))return{isValid:!1,errorMessage:n.message,forField:n.field,force:!!a};a&&v(e,null,!0,a)}return{isValid:!0}}(e),o&&o.set("validationResult",a.isValid),a.isValid?(delete O[a.forField||e.name],r&&m(e),a):(n&&(O[a.forField||e.name]=!0),(r||a.force)&&v(e,a.errorMessage,i||a.force,a.forField),a)},v=function(e,r,i,n){if(n||e){var o=n||e.name,l=t.get(R,o+".component");l&&(r&&"string"==typeof r&&(r=r.replace("amp;","")),r&&"object"==typeof r&&(r=a.get(P(s),r.setting+"."+r.variation)),i?(l.set("errorMessageForce",""),l.set("errorMessageForce",r)):(l.set("errorMessageForce",r),l.set("errorMessage",r)),l.set("showErrorHighlighting",Boolean(r)))}},m=function(e,t){v(e,null,t)},w=function(){return 0!==Object.keys(O).length},y=function(e){var r,i=e.errorMessage||"",n=e.errorAdvisory||"",o=e.formMessage||"";e.field&&(r=e.field.split(".").pop());var d={errorHeader:"",errorAdvisory:"",errorField:"",field:e.field};if(r){d.errorField=i;var u=r+"Label",c=a.get(P(s),u);if(o)d.errorHeader=t.interpolate(o,{dataError:c});else{var f=a.get(l("MY_PROFILE_ADDRESS","profileArea"),"myProfileAddressErrorHeader.SINGLE_FIELD_IN_ERROR");d.errorHeader=f.replace(/"\{\{([^}]+)\}\}"/g,c)}}return d.errorHeader=d.errorHeader||i,d.errorAdvisory=n,d},g=function(){var e={};return Object.keys(s.model).filter((function(e){return null!==e.match(/Error$/)})).map((function(e){return t.camelCase(e.replace(/Error$/,""))})).forEach((function(t){e[t]=t})),C.findAll("[name]").filter((function(t){var r=t.name.split(".").pop();return!!e[r]}))},b=function(){var e={},i=[];i=(i=(i=(i=i.concat(C.findAllComponents("dashboardInput"))).concat(C.findAllComponents("blueInput"))).concat(C.findAllComponents("blueSelect"))).concat(C.findAllComponents("blueCheckbox"));var n=g();return i.forEach((function(i){var n=r(i.el).find("[name]");if(n.length>0){var a=n[0].name;t.set(e,a+".component",i)}})),n.forEach((function(r){t.set(e,r.name+".node",r)})),R=e},k=function(e){var t,r,i,n=e.split("."),a=n.length>1;return null!==n[n.length-1].match(/^\d+$/)&&(t=n.pop()),1===n.length?r=n=i=n[0]:(r=n.pop(),i=n.map((function(e){return e+".items"})).join("."),n=n.join(".")+"."+r),{keypath:n,index:t,property:r,specpath:i,isListType:a}};var K,Q,W,X,Z,ee,te;return K=C.observe("*",t.debounce(A,200),{init:!1,defer:!0}),Q=!1,W={},X=function(){var e,t;return{set:function(r){t=(e=r).value},shouldValidate:function(){var r=e.value;return""===r.trim()||r!==t}}}(),Z=function(e){var t,r="focusout"===e.type||"focusin"===e.type;"checkbox"===e.target.type?E(e.target,r,!1,!0):(t=X.shouldValidate())&&h(e.target,r,!1,!0),!1===t&&delete O[e.target.name]},ee=function(){Q=!1,r(u).off(".validator")},te=function(e){var i=e.target.name;W.hasOwnProperty(i)?W[i]+=1:W[i]=0,X.set(e.target),!Q&&i&&(Q=!0,H||(b(),H=!0),t.get(R,i)?(r(u).on("keyup.validator change.validator","[name]",Z),r(u).one("blur","[name]",(function(e){ee(),Z(e)})),W[i]>0&&Z(e)):ee())},r(u).on("focus","[name]",te),V={teardown:function(){K.cancel(),r(u).off(".validator"),r(u).off("focus","[name]",te)},resetFocusState:function(){Q=!1}},A(),{teardown:function(){T=!1,r(u).find('button[type="submit"]').off(),r(u).off(),n.teardown(),U.teardown(),V.teardown()}}}}}}));