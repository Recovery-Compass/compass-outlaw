define(["require","blue/$","blue/event/channel/component"],(function(e){var t=e("blue/$"),n=e("blue/event/channel/component");return function(){return function(e){var r=this,a=t(e).find("input"),o=function(e){return null!==e.match(/\d/)},l=function(e,t){for(var n,r="",a=0,l=0,i=t||e.length;l<e.length&&a<i;)n=e[l],o(n)&&(r+=n,a++),l++;return r},i=function(e,t){return"domesticPhoneNumber"===t?(r=(n=e).replace(/[^\d]/g,""),a=n.replace(/[^-]/g,""),o=3===r.length&&"-"===n[3]&&1===a.length,i=3===r.length&&"-"===n[3]&&"-"===n[4]&&2===a.length,c=6===r.length&&"-"===n[7]&&2===a.length,s=6===r.length&&"-"===n[7]&&"-"===n[8]&&3===a.length,u=r.length>3&&r.length<=6,g=r.length>6,h=r.length<=3,f=n.slice(0,4),v=n.slice(0,8),d=r.slice(0,3)+"-"+r.slice(3),m=r.slice(0,3)+"-"+r.slice(3,6)+"-"+r.slice(6,10),o||i?f:c||s?v:u?d:g?m:h?r:void 0):"workPhoneNumberExt"===t?function(e){return l(e,4)}(e):"internationalPhoneNumber"===t?function(e){return l(e,16)}(e):l(e);var n,r,a,o,i,c,s,u,g,h,f,v,d,m},c=function(e){var t;if(document.selection){e.focus();var n=document.selection.createRange();n.moveStart("character",-e.value.length),t=n.text.length}else(e.selectionStart||"0"===e.selectionStart)&&(t=e.selectionStart);return t},s={_values:{domesticPhoneNumber:"",internationalPhoneNumber:""},get:function(e){return this._values[e]},set:function(e,t){this._values[t]=e}},u=function(e){var t=r.get("autoformat"),n=a[0],o=i(e,t),l=c(n);return r.set("value",o),s.set(o,t),a.val(o),function(e,t,n){if(e.setSelectionRange)t?"domesticPhoneNumber"!==n||4!==t&&8!==t?e.setSelectionRange(t,t):e.setSelectionRange(t+1,t+1):e.setSelectionRange(0,0);else if(document.selection){e.focus();var r=document.selection.createRange();r.moveEnd("character",t),r.select()}}(n,l,t),o},g=function(e,t,n){if(e.setSelectionRange)e.setSelectionRange(t+n,t+n);else if(document.selection){e.focus();var r=document.selection.createRange();r.moveEnd("character",t+n),r.select()}},h={_start:0,_end:0,get:function(){return{start:this._start,end:this._end}},set:function(e){this._start=e.start,this._end=e.end}},f={_start:0,_end:0,get:function(){return{start:this._start,end:this._end}},set:function(e){h.set({start:this._start,end:this._end}),this._start=e.start,this._end=e.end}},v=function(e){var t,n,r,a,o,l=0,i=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(l=e.selectionStart,i=e.selectionEnd):(n=document.selection.createRange())&&n.parentElement()===e&&(a=e.value.length,t=e.value.replace(/\r\n/g,"\n"),(r=e.createTextRange()).moveToBookmark(n.getBookmark()),(o=e.createTextRange()).collapse(!1),r.compareEndPoints("StartToEnd",o)>-1?l=i=a:(l=-r.moveStart("character",-a),l+=t.slice(0,l).split("\n").length-1,r.compareEndPoints("EndToEnd",o)>-1?i=a:(i=-r.moveEnd("character",-a),i+=t.slice(0,i).split("\n").length-1))),{start:l,end:i}},d=function(e,t,n,r){e=e||0;var a=f.get(),o=a.start||0,l=a.end||0;(function(e,t){var n=h.get(),r=s.get(t).slice(0,n.start)+s.get(t).slice(n.end);return n.end-n.start>1&&e.length>r.length})(r,n)||""===r||l-o>1?u(r):4===e?s.get(n).slice(5)?(u(s.get(n).slice(0,e)+s.get(n).slice(e+1)),g(t,e,-1)):u(s.get(n).slice(0,3)):8===e?s.get(n).slice(9)?(u(s.get(n).slice(0,e)+s.get(n).slice(e+1)),g(t,e,-1)):u(s.get(n).slice(0,7)):u(r)},m=function(e,t,n){r.set("value",e),a.val(e),g(t,n,-1)};return function(){var e=r.get("autoformat");if(e){n.on("resetBrokeragePhoneInput",(function(){s.set("",e)})),s.set(i(a.val(),e),e),a.on("input",(function(e){var t=c(a[0]),n=r.get("autoformat");if(n){var o=s.get(n);"domesticPhoneNumber"===n?function(e,t,n,r){var o="";e.target&&e.target.value?o=e.target.value:e.srcElement&&e.srcElement.value&&(o=e.srcElement.value);o.length>12||o.replace(/[\d-]/g,"")?m(n,a[0],t):e.target.value.length<n.length?d(t,a[0],r,e.target.value):e.target.value.length-n.length>1?(u(e.target.value),g(a[0],t,1)):o.length&&u(e.target.value)}(e,t,o,n):"internationalPhoneNumber"===n?e.target.value.length>16||e.target.value.replace(/[\d-]/g,"")?m(o,a[0],t):e.target.value.length&&u(e.target.value):"workPhoneNumberExt"===n&&(e.target.value.length>4||e.target.value.replace(/[\d-]/g,"")?d(t,a[0],n,e.target.value):e.target.value.length&&u(e.target.value))}})),a.on("mouseup",(function(){var e=v(a[0]);f.set(e)})),a.on("mouseout",(function(){var e=v(a[0]);f.set(e)}));var t={224:!1,91:!1,93:!1};if(a.on("keydown",(function(e){if(e.keyCode in t&&(t[e.keyCode]=!0),!{8:"backspace",16:"shift",17:"control",18:"alt",20:"capsLock",46:"delete",224:"appleKeyFirefox",91:"appleKeyWebkitLeft",93:"appleKeyFirefoxRight"}[e.keyCode]){var n=c(a[0])||0;f.set({start:n,end:n})}65===e.keyCode&&function(){for(var e in t)if(t[e])return!0;return!1}()&&f.set({start:0,end:a.val().length})})),a.on("keyup",(function(e){var n={37:"leftArrow",39:"rightArrow"};if(e.keyCode in t&&(t[e.keyCode]=!1),e.ctrlKey&&e.shiftKey&&n[e.keyCode]||e.shiftKey&&n[e.keyCode]){var r=v(a[0]);f.set(r)}})),r.findComponent("blueInput")||r.findComponent("dashboardInput")){var o=r.get("autoformat"),l=i(a.val(),o);r.set("value",l),this.view&&this.view.bridge.output.emit("resetDirtyState")}}}(),{teardown:function(){a&&a.off()}}}}}));