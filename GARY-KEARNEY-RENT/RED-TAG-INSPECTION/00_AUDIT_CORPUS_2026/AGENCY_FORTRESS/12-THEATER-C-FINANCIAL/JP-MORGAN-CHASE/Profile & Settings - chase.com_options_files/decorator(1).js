define(["require","blue/util","blue/$","blue-app/component/validator","profileArea/sharedLib/sharedView/decorators/exitDialog/ractiveModelCache","appkit-utilities/content/dcu","blue/event/channel/component","common/lib/fakeComponent","blue-view-ractive/ractive"],(function(e){var t=e("blue/util"),r=e("blue/$"),n=e("blue-app/component/validator"),i=e("profileArea/sharedLib/sharedView/decorators/exitDialog/ractiveModelCache"),a=e("appkit-utilities/content/dcu").dynamicContent,o=e("blue/event/channel/component"),l=e("common/lib/fakeComponent");return function(s,d){return function(){return function(u,c){(d=d||{}).customValidations=d.customValidations||[],d.ignoreFrameworkValidation=d.ignoreFrameworkValidation||!1,d.cancelButton=d.cancelButton||"";var f,p,v,g,m,b,h,y,V,E,k,A,w,C=this,M=e("blue-view-ractive/ractive");C.decoratorNode=u;var S,F,D,I,N,j,x,_=C.get("savedOriginalState"),B=_||r(u).serialize(),L={},R=!1,H={},O=!0,T=function(e){return e.bridge.name=e.bridge.name.replace("-bridge",""),l(e.bridge.name.toUpperCase(),"profileArea")},P=(I=d.customValidations,N={},j=[],x=[],I&&I.forEach((function(e){switch(e.type){case"field":var t=e.field;N[t]=N[t]||[],N[t].push(e);break;case"fields":(e.fields&&Array.isArray(e.fields)?e.fields:[]).forEach((function(t){N[t]=N[t]||[],N[t].push(e)}));break;case"form":j.push(e);break;case"submit":x.push(e)}})),{fieldValidations:N,formValidations:j,submitValidations:x});S=P.fieldValidations,F=P.formValidations,D=P.submitValidations,i.set(C,s);var q=function(e){var t=r(e).find('button[type="submit"]'),n=this.findAllComponents("blueButton").filter((function(e){return"submit"===e.get("type")})),i=void 0,a=r(".skiplink-container"),o=!0,l=function(e){var n=r(e.target).is(t)||r(e.target).parent().is(t);if((r(e.target).is("input")||n)&&(13===e.keyCode||"click"===e.type)){if(o)return!!r(e.target).hasClass("accordion-link")||(e.preventDefault(),!1);var i=p();if(!i.isValid)return s.context.broadcast("clearEmailHeaderConfirmation"),f.show(i.errorTitle,i.errorMessage),e.preventDefault(),!1;f.hide()}};d.cancelButton&&s.bridge.output.on("ractiveModelCacheExitDialog",(function(e){(i=s.rtemplate.findAllComponents("blueButton").find((function(e){return"doNotUpdateMyIncome"===e.get("id")})))&&i.set("disabled",!e.data.isDirty)}));var u=function(){r(e).on("keydown keypress keyup",l),t.on("click",l)};return u(),{enable:function(){o=!1,t.prop("disabled",o),n?n.forEach((function(e){e.set("disabled",o)})):s.bridge.output.emit("toggleSubmitButton",{disabled:o}),a.hide()},disable:function(){o=!0,t.prop("disabled",o),n?n.forEach((function(e){e.set("disabled",o)})):s.bridge.output.emit("toggleSubmitButton",{disabled:o}),a.show()},reset:function(){t.off("click",l),t=r(e).find('button[type="submit"]'),r(e).off("keydown keypress keyup",l),u()}}}.call(this,u);f=function(e){var t=M.getNodeInfo(e).keypath?M.getNodeInfo(e).keypath+".formValidatorError":"formValidatorError";return{show:function(e,r,n){n?n+=".formValidatorError":n=t,C.set(n+".title",e),C.set(n+".message",r),C.set(n+".additionalContent",null),C.set(n+".display",!0)},hide:function(e){e?e+=".formValidatorError":e=t,C.get(e)&&C.set(e+".display",!1)}}}(u);var $,z,U=function(){var e,n=[];s.bridge.on("trigger/serverValidation",(function(e){var r=y(e),n=r.errorHeader||"",i=r.errorAdvisory||"";if(f.show(n,i,e.dataPath),r.field){var a=t.object.get(L,r.field+".node");v(a,r.errorField,true),s.bridge.output.emit("state",{value:"saveMailingAddressChangesEnded",node:a}),V.resetFocusState()}r.enableJitButton&&q.enable()}));var a=function(e,r){e&&e.data?f.hide(e.data):f.hide(),e&&(H={},m().forEach((function(e){var n=t.object.get(L,e.name+".node");if(n){if(r&&r[n.name])return;g(n),g(n,!0)}}))),e.skipJIT||q.disable()};s.bridge.on("trigger/clearValidation",a);var l=function(e){if(e&&e.context&&e.context.id){var t=e.context.id;if(document.querySelector){var r=document.querySelector("#"+t);if(r){var n=M.getNodeInfo(r).ractive,i=n.find("input");i&&(e.context.newValue&&n.set("value",e.context.newValue),h(i,!0,!0,!0))}}}};s.bridge.output.on("runValidation",l),s.bridge.on("trigger/runValidation",l);var d=function(e){var t=e.data.name,r=e.data.clearAll||!1,n=e.data.clearException||!1,i=document.querySelector('[name="'+t+'"]');i&&i.value&&""!==i.value.trim()?(a(r,n),h(i,!0,!0,!0)):a(r,n)};s.bridge.output.on("revalidate",d),e=o.on("revalidate",d)[0],n.push(e);var c=function(e){var t={};return e.split("&").forEach((function(e){var r=e.split("=");2===r.length&&(t[r[0]]=r[1])})),t},p=function(){var e=r(u).serialize(),t=c(B),n=c(e);t.service!==n.service||_||(B=r(u).serialize()),i.teardown(),i.set(C,s),A()};return s.bridge.output.on("resetDirtyState",p),s.bridge.on("trigger/resetDirtyState",p),{parseString:c,teardown:function(){n.forEach((function(e){e()}))}}}(),G=(z=function(e,t){var r=$(e);r&&v(r,t,!0)},{get:$=function(e){var r=t.object.get(L,e);if(r)return r.node},set:z,clear:function(e){z(e,null)}}),J=function(e,t,r,i){var a=e.type||e,o=e.params||e,l=n.validate(t.value.trim(),a,o,e),s=i+"Error",d=t.value.trim();return t.required&&""===d?(r.setting=s,r.variation="MISSING_MANDATORY_DATA",l.isValid=!1):l.isValid||(""===d?l.isValid=!0:l.failedConstraints&&l.failedConstraints[0]&&"NotPhoneEmail"===l.failedConstraints[0].type?(r.setting=s,r.variation="EMAIL_ADDRESS_CANNOT_BE_PHONE_NUMBER"):(r.setting=s,r.variation="INVALID_FORMAT")),l.errorMessage=r,l},Y=function(e){if(e)return"string"==typeof e?e:a.get(e.spec,e.setting+"."+e.variation)};p=function(){if(O){if(D)for(var e=0;e<D.length;e++){var t=D[e];if(!t.validator.call(G,C,B,c,s))return{isValid:!1,errorTitle:Y(t.title),errorMessage:Y(t.message)}}return{isValid:!0}}},A=function(){var e=m();if(q.reset(),w())return q.disable();for(var t=0;t<e.length;t++){if(!h(e[t],!1,!1,!1).isValid)return q.disable()}return function(){if(O){if(F)for(var e=0;e<F.length;e++)if(!F[e].validator.call(G,C,B,c,s))return!1;return!0}}()?q.enable():q.disable()},h=function(e,r,n,i){var a;b();var o=t.object.get(L,e.name+".component");return d.ignoreFrameworkValidation||(a=function(e){if(O){var r,n,i,a=E(e.name),o=a.property,l=s.compSpec,d=s.compSpecValidationName;return d&&(i=l.data[d].items?l.data[d].items:l.data[d]),(n=i||t.object.get(s,"component.spec.data."+a.specpath))&&a.isListType?r=n[o]:n&&!a.isListType&&(r=n),r?J(r,e,{},o):{isValid:!0}}}(e)||{},o&&o.set("validationResult",a.isValid),a.isValid)?(delete H[e.name],k(e,r,n,i)):(i&&(H[e.name]=!0),r&&v(e,a.errorMessage,n),a)},k=function(e,r,n,i){var a;b();var o=t.object.get(L,e.name+".component");return a=function(e){if(!O)return{isValid:!0};var t=E(e.name).keypath,r=S[t];if(r)for(var n=0;n<r.length;n++){var i=r[n],a=t!==i.field?i.field:null;if(!i.validator.call(G,C,B,c,s))return{isValid:!1,errorMessage:i.message,forField:i.field,force:!!a};a&&v(e,null,!0,a)}return{isValid:!0}}(e),o&&o.set("validationResult",a.isValid),a.isValid?(delete H[a.forField||e.name],r&&g(e),a):(i&&(H[a.forField||e.name]=!0),(r||a.force)&&v(e,a.errorMessage,n||a.force,a.forField),a)},v=function(e,r,n,i){if(i||e){var o=i||e.name,l=t.object.get(L,o+".component");l&&(r&&"string"==typeof r&&(r=r.replace("amp;","")),r&&"object"==typeof r&&(r=a.get(T(s),r.setting+"."+r.variation)),n?(l.set("errorMessageForce",""),l.set("errorMessageForce",r)):(l.set("errorMessageForce",r),l.set("errorMessage",r)),l.set("showErrorHighlighting",Boolean(r)))}},g=function(e,t){v(e,null,t)},w=function(){return 0!==Object.keys(H).length},y=function(e){var r,n=e.errorMessage||"",i=e.errorAdvisory||"",o=e.formMessage||"";e.field&&(r=e.field.split(".").pop());var d={errorHeader:"",errorAdvisory:"",errorField:"",field:e.field};if(r){d.errorField=n;var u=r+"Label",c=a.get(T(s),u);if(o)d.errorHeader=t.string.interpolate(o,{dataError:c});else{var f=a.get(l("MY_PROFILE_ADDRESS","profileArea"),"myProfileAddressErrorHeader.SINGLE_FIELD_IN_ERROR");d.errorHeader=f.replace(/"\{\{([^}]+)\}\}"/g,c)}}return d.errorHeader=d.errorHeader||n,d.errorAdvisory=i,d},m=function(){var e={};return Object.keys(s.model).filter((function(e){return null!==e.match(/Error$/)})).map((function(e){return t.string.camelCase(e.replace(/Error$/,""))})).forEach((function(t){e[t]=t})),C.findAll("[name]").filter((function(t){var r=t.name.split(".").pop();return!!e[r]}))},b=function(){var e={},n=[];n=(n=(n=(n=n.concat(C.findAllComponents("dashboardInput"))).concat(C.findAllComponents("blueInput"))).concat(C.findAllComponents("blueSelect"))).concat(C.findAllComponents("blueCheckbox"));var i=m();return n.forEach((function(n){var i=r(n.el).find("[name]");if(i.length>0){var a=i[0].name;t.object.set(e,a+".component",n)}})),i.forEach((function(r){t.object.set(e,r.name+".node",r)})),L=e},E=function(e){var t,r,n,i=e.split("."),a=i.length>1;return null!==i[i.length-1].match(/^\d+$/)&&(t=i.pop()),1===i.length?r=i=n=i[0]:(r=i.pop(),n=i.map((function(e){return e+".items"})).join("."),i=i.join(".")+"."+r),{keypath:i,index:t,property:r,specpath:n,isListType:a}};var K,Q,W,X,Z,ee,te;return K=C.observe("*",t.function.debounce(A,200),{init:!1,defer:!0}),Q=!1,W={},X=function(){var e,t;return{set:function(r){t=(e=r).value},shouldValidate:function(){var r=e.value;return""===r.trim()||r!==t}}}(),Z=function(e){var t,r="focusout"===e.type||"focusin"===e.type;"checkbox"===e.target.type?k(e.target,r,!1,!0):(t=X.shouldValidate())&&h(e.target,r,!1,!0),!1===t&&delete H[e.target.name]},ee=function(){Q=!1,r(u).off(".validator")},te=function(e){var n=e.target.name;W.hasOwnProperty(n)?W[n]+=1:W[n]=0,X.set(e.target),!Q&&n&&(Q=!0,R||(b(),R=!0),t.object.get(L,n)?(r(u).on("keyup.validator change.validator","[name]",Z),r(u).one("blur","[name]",(function(e){ee(),Z(e)})),W[n]>0&&Z(e)):ee())},r(u).on("focus","[name]",te),V={teardown:function(){K.cancel(),r(u).off(".validator"),r(u).off("focus","[name]",te)},resetFocusState:function(){Q=!1}},A(),{teardown:function(){O=!1,r(u).find('button[type="submit"]').off(),r(u).off(),i.teardown(),U.teardown(),V.teardown()}}}}}}));